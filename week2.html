<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第２週作業</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="head" class="head" >
      <form>
        <label for="user">帳號:</label>
        <input id="user" type="mail">
        <br>
        <label for="password">密碼:</label>
        <input id="password" type="password">
      </form> 
       <button id="button" class="btn btn-primary">登入</button>
    </div> 
    
    
    <div class="container">
      <div id="app" class="container">
        <table class="table mt-4">
          <thead>
            <tr>
              <th>產品名稱</th>
              <th width="120">
                商品圖片
              </th>
              <th width="120">
                原價
              </th>
              <th width="120">
                售價
              </th>
              <th width="150">
                是否啟用
              </th>
              <th width="120">
                刪除
              </th>
            </tr>
          </thead>
          <tbody id="productList">
            <tr>
              <td>範例標題</td>
              <td width ="120">
                商品圖片
              </td>    
              <td width ="120">
                範例原價
              </td>
              <td width="120">
                範例價格
              </td>
              <td width="100">
                <span class="">範例啟用狀態</span>
              </td>
              <td width="120">
                <button type="button" class="btn btn-sm btn-outline-danger move deleteBtn" data-action="remove" data-id=""> 刪除 </button>
              </td>
            </tr>
          </tbody>
        </table>
        <p>目前有 <span id="productCount">0</span> 項產品</p>
      </div>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.9.1/axios.min.js'
            integrity='sha512-Xk3wWei2TGrsh9kDSBKUMIjw/86sLUvhtnv9f7fOuIwhhiUTKz8szkWkzHthrM5Bb3Bu9idSzkxOrkzhcneuiw=='
            crossorigin='anonymous'>    
    
    </script>

<script>
const usernameInput = document.querySelector('#user');
const passwordInput = document.querySelector('#password');

const button = document.getElementById('button');
button.addEventListener('click',login);

const url = 'https://vue3-course-api.hexschool.io';
const path = 'patrickapi';

//將token存到Cookie
function login(){
  const username = usernameInput.value; 
  const password = passwordInput.value;
  const data = { 
   username,
   password
   }
  console.log(data);   
  axios.post(`${url}/admin/signin`,data)
  .then((res)=>{
    console.log(res);
    if(res.data.success){
      const {token,expired} = res.data;
      console.log(token,expired);
      document.cookie = `hexToken=${token}; expires=${new Date(expired)}`;
    }
    else{
        alert('連線失敗');
    }    
  }) 
}  

const app = {
    data:{
        products:[],
    },
    getData(){
    //取得商品列表    
    axios.get(`${url}/api/${path}/admin/products`)   
    .then((res)=>{
        console.log(res);
        if(res.data.success){
        res.data.products.forEach((item,key)=>{
        this.data.products[key] = res.data.products[key];
        this.data.products[key].use = true;
        console.log(this.data.products);
        this.render();

        })       
      }        
    })    
},
render(){
    const Dom = document.querySelector('#productList');
    let template = '';
    this.data.products.forEach((item)=>{
        console.log(item);
       template =  template + `
    <tr>
        <td>${item.title}</td>
        <td>
        <img src="${item.imageUrl}" style=" width:150px; height:100px ">
        </td>
        <td>${item.origin_price}</td>
        <td>${item.price}</td>
        <td>
            <input data-id="${item.id}" class="form-check-input transfer" type="checkbox"   ${ item.use? 'checked' : ''} > 
            <label class="form-check-label" for=" ${item.id} " > ${item.use? '啟用' : '未啟用'} </label>
        </td>
        <td>
            <button type="button" data-id="${item.id}" class="btn btn-sm btn-outline-danger delect" ">  刪除  </button>
        </td>    
    </tr>
    `;
    })
    console.log(template);
    Dom.innerHTML = template;

    const delect = document.querySelectorAll('.delect');
    delect.forEach((item,key)=>{
        console.log(item);
        item.addEventListener('click',this.delete);
    })

    const transfer = document.querySelectorAll('.transfer');
    transfer.forEach((item,key)=>{
        console.log(item);
        item.addEventListener('click',this.transfer);
    })
},
delete(evt){
    console.log(evt);    
    const id = evt.target.dataset.id;
    axios.delete(`${url}/api/${path}/admin/product/${id}`)
    .then((res)=>{
        console.log(res);
        app.getData();
    })
},
transfer(evt){
    const isTrusted = evt.isTrusted;
    const id = evt.target.dataset.id;
    console.log(id);
    axios.put(`${url}/api/${path}/admin/product/${id}`)
     .then((res)=>{
         console.log(res);
     })
    
},
init(){
        //取出token
        const token = document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*\=\s*([^;]*).*$)|^.*$/, "$1");
        //token存到heders
        axios.defaults.headers.common['Authorization'] = token; 
        //console.log(token);
        //檢查是否正確登入
        // axios.post(`${url}/api/user/check`)
        // .then((res)=>{
        //     console.log(res);
        // })
        this.getData();
}
}
app.init();

    </script>   

  </body>

</html>